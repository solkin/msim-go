# Передача файлов в mSIM

Протокол mSIM поддерживает онлайн передачу файлов между клиентами через TCP прокси на сервере. Благодаря простоте протокола, для передачи файлов можно использовать стандартные Unix утилиты, такие как `nc` (netcat).

## Как это работает

1. **Инициация**: Отправитель предлагает файл получателю через команду `fsnd`
2. **Принятие**: Получатель принимает файл через команду `facc`, сервер выделяет два TCP порта
3. **Передача**: Отправитель загружает файл на один порт, получатель скачивает с другого порта через `nc`
4. Сервер выступает как TCP прокси, пробрасывая данные напрямую

## Пример использования

### Сценарий 1: Передача фотографии

**Отправитель (alice):**

```bash
# Терминал 1: Подключаемся к серверу
nc server.example.com 3215

# Авторизуемся
auth|alice|password
# << ok|auth

# Инициируем передачу
fsnd|bob|vacation.jpg|5242880|sha256:abc123def456
# << ok|fsnd|a1b2c3d4|300

# Ждем принятия...
# >> facc|bob|a1b2c3d4|35042

# Терминал 2: Отправляем файл
cat vacation.jpg | nc server.example.com 35042
```

**Получатель (bob):**

```bash
# Терминал 1: Подключаемся к серверу
nc server.example.com 3215

# Авторизуемся
auth|bob|password
# << ok|auth

# Получаем уведомление о файле
# >> fsnd|alice|vacation.jpg|5242880|sha256:abc123def456|a1b2c3d4

# Принимаем файл
facc|alice|a1b2c3d4
# << ok|facc|35001

# Терминал 2: Скачиваем файл
nc server.example.com 35001 > vacation.jpg

# Проверяем целостность (опционально)
sha256sum vacation.jpg
```

### Сценарий 2: Отклонение файла

**Получатель (bob):**

```bash
nc server.example.com 3215
auth|bob|password
# << ok|auth

# Получаем уведомление
# >> fsnd|alice|bigfile.zip|1073741824|sha256:...|f1e2d3c4

# Отклоняем файл
fdec|alice|f1e2d3c4|too large
# << ok|fdec
```

**Отправитель (alice) получит:**
```
# >> fdec|bob|f1e2d3c4|too large
```

### Сценарий 3: Отмена передачи

Любая сторона может отменить передачу в процессе:

```bash
fcan|user|session_id|reason
# << ok|fcan
```

## Команды протокола

### fsnd - Отправка файла

Инициация передачи файла:

```
fsnd|recipient|filename|size|hash
```

- `recipient` - логин получателя
- `filename` - имя файла
- `size` - размер в байтах
- `hash` - хеш для проверки (опционально, можно оставить пустым)

**Ответ сервера:**
```
ok|fsnd|session_id|expires_in
```

### facc - Принятие файла

Принятие предложенного файла:

```
facc|sender|session_id
```

**Ответ сервера:**
```
ok|facc|download_port
```

**Отправитель получит:**
```
facc|recipient|session_id|upload_port
```

### fdec - Отклонение файла

Отклонение предложенного файла:

```
fdec|sender|session_id|reason
```

**Ответ сервера:**
```
ok|fdec
```

### fcan - Отмена передачи

Отмена передачи любой стороной:

```
fcan|user|session_id|reason
```

**Ответ сервера:**
```
ok|fcan
```

### fst - Статус передачи

Проверка статуса передачи:

```
fst|session_id
```

**Ответ сервера:**
```
fst|session_id|status
```

Возможные статусы:
- `pending` - ожидание принятия
- `accepted` - принято, порты выделены
- `transferring` - идет передача
- `completed` - завершено успешно
- `declined` - отклонено получателем
- `cancelled` - отменено одной из сторон

## Ограничения

- **Таймауты:**
  - 5 минут на принятие файла после инициации
  - 10 минут на завершение передачи после принятия

- **Порты:**
  - По умолчанию используется диапазон 35000-35999
  - Настраивается через `MSIM_FILE_PORT_START` и `MSIM_FILE_PORT_END`
  - Максимум 1000 одновременных передач (по умолчанию)

- **Размер файла:**
  - Ограничен только доступной памятью и дисковым пространством
  - Рекомендуется проверять хеш после передачи больших файлов

## Проверка целостности

Для проверки целостности файла используйте хеш-сумму:

```bash
# Отправитель вычисляет хеш
sha256sum myfile.txt
# Вывод: abc123def456... myfile.txt

# Инициирует передачу с хешем
fsnd|bob|myfile.txt|12345|sha256:abc123def456

# Получатель после скачивания проверяет
sha256sum myfile.txt
# Должен совпасть с указанным хешем
```

## Советы и рекомендации

1. **Используйте `pv` для прогресса:**
   ```bash
   pv myfile.dat | nc server 35042
   ```

2. **Сжатие на лету:**
   ```bash
   # Отправитель
   gzip -c myfile.dat | nc server 35042
   
   # Получатель
   nc server 35001 | gunzip > myfile.dat
   ```

3. **Передача директории:**
   ```bash
   # Отправитель
   tar czf - mydir/ | nc server 35042
   
   # Получатель
   nc server 35001 | tar xzf -
   ```

4. **Проверка соединения:**
   ```bash
   # Перед передачей проверьте статус
   fst|session_id
   ```

## Безопасность

- Файлы передаются в открытом виде через TCP
- Для защиты данных рекомендуется:
  - Использовать шифрование на уровне приложения
  - Запускать сервер за VPN или SSH туннелем
  - Проверять хеш-суммы после передачи

## Отладка

Если передача не работает:

1. Проверьте, что порты доступны:
   ```bash
   nc -zv server.example.com 35000-35999
   ```

2. Проверьте статус сессии:
   ```bash
   fst|session_id
   ```

3. Проверьте логи сервера:
   ```bash
   docker logs msim-server
   ```

4. Убедитесь, что сессия не истекла (проверьте `expires_in`)

## Примеры скриптов

### Скрипт для отправки файла

```bash
#!/bin/bash
# send-file.sh

SERVER="localhost:3215"
RECIPIENT="$1"
FILE="$2"

if [ -z "$RECIPIENT" ] || [ -z "$FILE" ]; then
    echo "Usage: $0 <recipient> <file>"
    exit 1
fi

FILENAME=$(basename "$FILE")
SIZE=$(stat -f%z "$FILE" 2>/dev/null || stat -c%s "$FILE")
HASH="sha256:$(sha256sum "$FILE" | awk '{print $1}')"

echo "Sending file to $RECIPIENT..."
echo "File: $FILENAME ($SIZE bytes)"

# Инициируем передачу (предполагается уже авторизованная сессия)
echo "fsnd|$RECIPIENT|$FILENAME|$SIZE|$HASH"

# Дальше нужно обработать ответ и запустить nc с полученным портом
```

### Скрипт для приема файла

```bash
#!/bin/bash
# receive-file.sh

SESSION_ID="$1"
OUTPUT_FILE="$2"
PORT="$3"

if [ -z "$SESSION_ID" ] || [ -z "$OUTPUT_FILE" ] || [ -z "$PORT" ]; then
    echo "Usage: $0 <session_id> <output_file> <port>"
    exit 1
fi

echo "Downloading file..."
nc localhost "$PORT" > "$OUTPUT_FILE"
echo "File saved to $OUTPUT_FILE"
```

## FAQ

**Q: Можно ли передавать несколько файлов одновременно?**  
A: Да, каждая передача использует отдельную пару портов.

**Q: Что происходит при обрыве соединения?**  
A: Передача прерывается, сессия остается активной до таймаута. Можно проверить статус через `fst`.

**Q: Можно ли возобновить прерванную передачу?**  
A: Нет, нужно инициировать новую передачу. Для больших файлов рекомендуется использовать другие инструменты (rsync, scp).

**Q: Как передать файл с пробелами в имени?**  
A: Имя файла экранируется автоматически протоколом mSIM (символ `|` заменяется на `\|`).

**Q: Нужно ли держать mSIM соединение открытым во время передачи?**  
A: Рекомендуется, чтобы получать уведомления об отмене. Но технически передача идет через отдельные порты.

