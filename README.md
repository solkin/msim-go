# mSIM

Реализация протокола mSIM на Go — сервер и консольный клиент.

## Описание

mSIM — лёгкий расширяемый протокол для обмена текстовыми сообщениями. Проект включает:

- **Сервер** — полная реализация спецификации протокола
- **Клиент** — консольный чат с terminal UI в стиле Midnight Commander

### Возможности

- Авторизация и регистрация пользователей
- Отправка и получение текстовых сообщений
- Подтверждение доставки сообщений (ack)
- История сообщений с пагинацией
- Управление списком контактов
- Уведомления о статусе контактов в реальном времени (онлайн/оффлайн)
- Время последнего изменения статуса контактов
- Подсчёт оффлайн-сообщений с момента последнего отключения
- **Передача файлов через TCP прокси** (с использованием netcat)

Подробная спецификация протокола доступна в файле [SPECIFICATION.md](SPECIFICATION.md).

## Клиент

Консольный чат-клиент с псевдографикой находится в директории `client/`.

### Быстрый старт

```bash
cd client
go mod tidy
go build -o msim-chat .
./msim-chat -server localhost:3215
```

### Возможности клиента

- Модальное окно авторизации/регистрации
- Список контактов со статусами (online/offline)
- Управление контактами (добавление, переименование, удаление)
- Чат с историей и сообщениями в реальном времени
- Подтверждение доставки сообщений
- Прокрутка истории (Tab для переключения режима)
- Статус подключения с отображением времени последнего ping
- Возможность отключения и переподключения (F6)

Подробная документация: [client/README.md](client/README.md)

## Сервер

### Требования

- Go 1.21 или выше
- SQLite3 (обычно входит в состав системы)

### Установка

```bash
go mod download
go build -o msim-server .
```

### Конфигурация

Сервер настраивается через переменные окружения:

- `MSIM_PORT` — порт для прослушивания (по умолчанию: 3215)
- `MSIM_DB_PATH` — путь к файлу базы данных SQLite (по умолчанию: `msim.db`)
- `MSIM_READ_TIMEOUT` — таймаут чтения в секундах (по умолчанию: 120)
- `MSIM_WRITE_TIMEOUT` — таймаут записи в секундах (по умолчанию: 30)
- `MSIM_FILE_PORT_START` — начало диапазона портов для передачи файлов (по умолчанию: 35000)
- `MSIM_FILE_PORT_END` — конец диапазона портов для передачи файлов (по умолчанию: 35999)

### Запуск

```bash
./msim-server
```

Или с переменными окружения:

```bash
MSIM_PORT=3215 MSIM_DB_PATH=/path/to/msim.db ./msim-server
```

### Управление сервером (msimctl.sh)

Для удобного управления сервером в Docker используйте скрипт `msimctl.sh`:

```bash
# Запуск сервера (сборка и запуск Docker контейнера)
./msimctl.sh start

# Просмотр статуса
./msimctl.sh status

# Просмотр статистики (активные подключения, онлайн-пользователи)
./msimctl.sh stats

# Просмотр логов (в режиме follow)
./msimctl.sh logs

# Перезапуск сервера
./msimctl.sh restart

# Остановка сервера (интерактивный режим)
./msimctl.sh stop
```

#### Остановка сервера

При остановке скрипт предлагает выбрать причину отключения (согласно спецификации mSIM):

1. **maintenance** — техническое обслуживание
2. **restart** — перезагрузка
3. **timeout** — таймаут (без указания времени)

Для `maintenance` и `restart` нужно указать ожидаемое время завершения:
- В минутах: `5` (через 5 минут)
- В формате ISO 8601: `2024-12-21T22:00:00Z`

Все подключённые клиенты получат уведомление `bye|reason|completion_time` перед отключением сервера.

### Docker

#### Запуск с docker-compose

Самый простой способ запустить сервер:

```bash
docker-compose up -d
```

Сервер будет доступен на порту 3215. База данных сохраняется в Docker volume `msim-data`.

Для остановки:

```bash
docker-compose down
```

Для просмотра логов:

```bash
docker-compose logs -f
```

**Ротация логов:** Логи автоматически ротируются с настройками:
- Максимальный размер файла лога: 10 МБ
- Количество сохраняемых файлов: 3
- Сжатие старых логов: включено

Логи хранятся в `/var/lib/docker/containers/<container-id>/` на хосте.

#### Сборка Docker образа

```bash
docker build -t msim-server .
```

#### Запуск контейнера

```bash
docker run -d \
  --name msim-server \
  -p 3215:3215 \
  -e MSIM_PORT=3215 \
  -e MSIM_DB_PATH=/app/data/msim.db \
  -v msim-data:/app/data \
  msim-server
```

## Архитектура проекта

```
msim/
├── client/           # Консольный клиент
│   ├── protocol/     # Клиентская библиотека протокола
│   ├── ui/           # Terminal UI (tview)
│   └── main.go       # Точка входа клиента
├── config/           # Конфигурация сервера
├── db/               # Работа с SQLite
├── models/           # Модели данных
├── protocol/         # Парсинг протокола (сервер)
├── server/           # TCP сервер и обработчики
├── main.go           # Точка входа сервера
├── SPECIFICATION.md  # Спецификация протокола
├── Dockerfile        # Docker образ сервера
└── docker-compose.yml
```

## База данных

Сервер использует SQLite для хранения данных. База данных создаётся автоматически при первом запуске.

Таблицы:
- **users** — пользователи (логин, хеш пароля)
- **contacts** — контакты пользователей (владелец, контакт, ник)
- **messages** — сообщения (отправитель, получатель, текст, время, статус)

## Тестирование

### Запуск тестов

```bash
go test ./...
```

### Ручное тестирование

Сервер можно протестировать через netcat или telnet:

```bash
# Через netcat (рекомендуется)
nc localhost 3215

# Или через telnet
telnet localhost 3215
```

**Примечание:** Некоторые версии telnet могут закрывать соединение после получения ответа. В этом случае рекомендуется использовать `nc` (netcat).

Пример сессии:

```
ping
pong
reg|user1|password1
ok|reg
auth|user1|password1
ok|auth
list
list|
add|user2@example.com|Friend
ok|add
msg|user2@example.com|Hello!
ok|msg
```

### Передача файлов через netcat

Протокол mSIM поддерживает передачу файлов через TCP прокси с использованием стандартных утилит.

**Пример передачи файла:**

Терминал 1 (отправитель - alice):
```bash
nc localhost 3215
auth|alice|password
ok|auth
fsnd|bob|photo.jpg|2048000|sha256:abc123
ok|fsnd|f4a3b2c1|300
# Ждем принятия...
facc|bob|f4a3b2c1|35002
# В другом терминале отправляем файл:
# cat photo.jpg | nc localhost 35002
```

Терминал 2 (получатель - bob):
```bash
nc localhost 3215
auth|bob|password
ok|auth
# Получаем уведомление:
fsnd|alice|photo.jpg|2048000|sha256:abc123|f4a3b2c1
# Принимаем файл:
facc|alice|f4a3b2c1
ok|facc|35001
# В другом терминале скачиваем файл:
# nc localhost 35001 > photo.jpg
```

Подробное описание протокола передачи файлов см. в [SPECIFICATION.md](SPECIFICATION.md#передача-файлов).

## Лицензия

Проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для подробностей.

