# mSIM Server

Реализация сервера протокола mSIM на Go.

## Описание

mSIM — лёгкий расширяемый протокол для обмена текстовыми сообщениями. Сервер реализует полную спецификацию протокола, включая:

- Авторизацию и регистрацию пользователей
- Отправку и получение текстовых сообщений
- Подтверждение доставки сообщений
- Историю сообщений с пагинацией
- Управление списком контактов
- Уведомления о статусе контактов (онлайн/оффлайн)

Подробная спецификация протокола доступна в файле [SPECIFICATION.md](SPECIFICATION.md).

## Требования

- Go 1.21 или выше
- SQLite3 (обычно входит в состав системы)

## Установка

```bash
go mod download
go build -o msim-server .
```

## Конфигурация

Сервер настраивается через переменные окружения:

- `MSIM_PORT` — порт для прослушивания (по умолчанию: 3215)
- `MSIM_DB_PATH` — путь к файлу базы данных SQLite (по умолчанию: `msim.db`)
- `MSIM_READ_TIMEOUT` — таймаут чтения в секундах (по умолчанию: 120)
- `MSIM_WRITE_TIMEOUT` — таймаут записи в секундах (по умолчанию: 30)

## Запуск

```bash
./msim-server
```

Или с переменными окружения:

```bash
MSIM_PORT=3215 MSIM_DB_PATH=/path/to/msim.db ./msim-server
```

## Docker

### Запуск с docker-compose

Самый простой способ запустить сервер:

```bash
docker-compose up -d
```

Сервер будет доступен на порту 3215. База данных сохраняется в Docker volume `msim-data`.

Для остановки:

```bash
docker-compose down
```

Для просмотра логов:

```bash
docker-compose logs -f
```

**Ротация логов:** Логи автоматически ротируются с настройками:
- Максимальный размер файла лога: 10 МБ
- Количество сохраняемых файлов: 3
- Сжатие старых логов: включено

Логи хранятся в `/var/lib/docker/containers/<container-id>/` на хосте.

### Сборка Docker образа

```bash
docker build -t msim-server .
```

### Запуск контейнера

```bash
docker run -d \
  --name msim-server \
  -p 3215:3215 \
  -e MSIM_PORT=3215 \
  -e MSIM_DB_PATH=/app/data/msim.db \
  -v msim-data:/app/data \
  msim-server
```

## Архитектура

Проект организован в следующие пакеты:

- `config` — загрузка конфигурации из переменных окружения
- `db` — работа с базой данных SQLite
- `models` — модели данных
- `protocol` — парсинг и форматирование пакетов протокола, экранирование
- `server` — TCP сервер и обработчики пакетов
- `main` — точка входа

## База данных

Сервер использует SQLite для хранения данных. База данных создаётся автоматически при первом запуске.

Таблицы:
- **users** — пользователи (логин, хеш пароля)
- **contacts** — контакты пользователей (владелец, контакт, ник)
- **messages** — сообщения (отправитель, получатель, текст, время, статус)

## Тестирование

### Запуск тестов

```bash
go test ./...
```

### Ручное тестирование

Сервер можно протестировать через netcat или telnet:

```bash
# Через netcat (рекомендуется)
nc localhost 3215

# Или через telnet
telnet localhost 3215
```

**Примечание:** Некоторые версии telnet могут закрывать соединение после получения ответа. В этом случае рекомендуется использовать `nc` (netcat).

Пример сессии:

```
ping
pong
reg|user1|password1
ok|reg
auth|user1|password1
ok|auth
list
list|
add|user2@example.com|Friend
ok|add
msg|user2@example.com|Hello!
ok|msg
```

## Лицензия

Проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для подробностей.

